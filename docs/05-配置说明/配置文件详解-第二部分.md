# 配置文件详解 - 第二部分

## 集群专用配置 (cluster-config.yml)

### 集群网络配置
```yaml
# 集群网络配置
network:
  # 节点间通信端口
  port: 7349
  # 广播地址
  advertise_addr: "192.168.1.100"
  # 绑定地址
  bind_addr: "0.0.0.0"
  # 节点发现超时
  discovery_timeout: "30s"
```

### 节点角色配置
```yaml
# 节点角色定义
roles:
  # 工作节点配置
  worker:
    # 最大工作线程数
    max_workers: 100
    # 队列大小
    queue_size: 1000
    
  # 领导节点配置
  leader:
    # 领导选举超时
    election_timeout: "15s"
    # 心跳间隔
    heartbeat_interval: "5s"
```

### 数据同步配置
```yaml
# 数据同步配置
sync:
  # 同步间隔
  interval: "10s"
  # 批量大小
  batch_size: 1000
  # 重试次数
  retry_count: 3
  # 重试间隔
  retry_interval: "1s"
```

## 监控配置 (prometheus.yml)

### 全局配置
```yaml
# Prometheus全局配置
global:
  # 抓取间隔
  scrape_interval: 15s
  # 评估间隔
  evaluation_interval: 15s
  # 外部标签
  external_labels:
    cluster: 'nakama-plus'
    environment: 'production'
```

### 抓取配置
```yaml
# 抓取目标配置
scrape_configs:
  # Nakama监控任务
  - job_name: 'nakama'
    # 抓取间隔（覆盖全局设置）
    scrape_interval: 10s
    # 抓取超时
    scrape_timeout: 5s
    # 指标路径
    metrics_path: '/metrics'
    # 目标地址
    static_configs:
      - targets: ['nakama:7350']
    # 标签重写
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '(.*)'
        replacement: 'nakama-$1'
```

### 告警规则配置
```yaml
# 告警规则配置
rule_files:
  - "alerts/*.yml"  # 告警规则文件路径

# 告警管理器配置
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
```

## Nginx负载均衡配置 (nginx.conf)

### 上游服务器配置
```nginx
# Nakama后端服务器定义
upstream nakama_backend {
    # 负载均衡策略
    least_conn;  # 最少连接策略
    
    # 服务器列表
    server nakama1:7350 weight=1 max_fails=3 fail_timeout=30s;
    server nakama2:7350 weight=1 max_fails=3 fail_timeout=30s;
    server nakama3:7350 weight=1 max_fails=3 fail_timeout=30s;
    
    # 健康检查配置
    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "HEAD /healthcheck HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

### 服务器块配置
```nginx
server {
    # 监听端口
    listen 80;
    listen 443 ssl http2;
    
    # 服务器名称
    server_name nakama.example.com;
    
    # SSL配置
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # API代理配置
    location / {
        proxy_pass http://nakama_backend;
        
        # 代理头部设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 缓冲区设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 静态文件服务
    location /static/ {
        root /var/www;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

## 配置最佳实践

### 生产环境配置建议
```yaml
# 安全配置
session:
  encryption_key: "生成一个安全的32字节密钥"
  signing_key: "生成一个安全的32字节密钥"

# 性能优化
database:
  max_open_conns: 200  # 根据服务器配置调整
  max_idle_conns: 50

# 监控配置
logger:
  level: "warn"  # 生产环境使用warn级别减少日志量
  format: "json"  # 便于日志分析
```

### 开发环境配置建议
```yaml
# 调试友好配置
logger:
  level: "debug"  # 开发环境使用debug级别
  format: "console"  # 便于阅读
  with_caller: true  # 显示调用者信息

# 快速开发
match:
  call_interval_ms: 100  # 更快的匹配响应
```

[配置文件详解完成，请查看其他文档章节]