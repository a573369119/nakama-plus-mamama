# 监控系统指南

## 监控系统概述

Nakama-plus集成了完整的监控系统，基于Prometheus和Grafana提供实时的性能监控、告警和可视化。

## 监控架构

### 组件关系图
```
Nakama节点 → 指标暴露 (/metrics) → Prometheus抓取 → Grafana可视化
                                  ↘ 告警规则 → Alertmanager通知
```

### 监控指标分类
- **系统指标**: CPU、内存、磁盘、网络使用情况
- **应用指标**: 请求量、响应时间、错误率、并发连接数
- **业务指标**: 在线用户数、匹配次数、消息吞吐量
- **数据库指标**: 查询性能、连接数、锁等待时间

## Prometheus配置详解

### 基本配置 (prometheus.yml)
```yaml
# 全局配置
global:
  scrape_interval: 15s      # 抓取间隔
  evaluation_interval: 15s  # 规则评估间隔

# 告警配置
alerting:
  alertmanagers:
    - static_configs:
        - targets: ["alertmanager:9093"]

# 规则文件
rule_files:
  - "alerts/*.yml"  # 告警规则文件

# 抓取配置
scrape_configs:
  - job_name: 'nakama'
    scrape_interval: 10s    # Nakama专用抓取间隔
    static_configs:
      - targets: ['nakama:7350']  # Nakama指标端点
    metrics_path: '/metrics'       # 指标路径
```

### 告警规则配置 (alerts/nakama-alerts.yml)
```yaml
groups:
  - name: nakama
    rules:
      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(nakama_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "高错误率检测"
          description: "错误率超过5%，当前值: {{ $value }}"
      
      # 高响应时间告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(nakama_http_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "高响应时间检测"
          description: "95%分位响应时间超过2秒，当前值: {{ $value }}秒"
      
      # 节点宕机告警
      - alert: NodeDown
        expr: up{job="nakama"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "节点宕机"
          description: "节点 {{ $labels.instance }} 已宕机"
```

## 关键监控指标

### 系统级指标
```promql
# CPU使用率
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 内存使用率
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

# 磁盘使用率
(node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100
```

### 应用级指标
```promql
# 请求率（按状态码）
sum by (status) (rate(nakama_http_requests_total[5m]))

# 错误率
sum(rate(nakama_http_requests_total{status=~"5.."}[5m])) / sum(rate(nakama_http_requests_total[5m])) * 100

# 响应时间分布
histogram_quantile(0.95, rate(nakama_http_duration_seconds_bucket[5m]))
```

### 业务级指标
```promql
# 在线用户数
nakama_users_online

# 活跃匹配数  
nakama_matches_active

# 消息吞吐量
rate(nakama_messages_sent_total[5m])
```

## Grafana仪表板配置

### 主要仪表板组件

#### 1. 系统状态面板
- CPU、内存、磁盘使用率图表
- 网络流量监控
- 系统负载指标

#### 2. 应用性能面板
- 请求量趋势图
- 响应时间分布
- 错误率监控

#### 3. 业务指标面板
- 在线用户统计
- 匹配活动监控
- 消息流量分析

### 仪表板JSON配置示例
```json
{
  "title": "Nakama-plus监控面板",
  "panels": [
    {
      "title": "请求率",
      "type": "graph",
      "targets": [
        {
          "expr": "sum(rate(nakama_http_requests_total[5m]))",
          "legendFormat": "总请求率"
        }
      ]
    },
    {
      "title": "错误率", 
      "type": "singlestat",
      "targets": [
        {
          "expr": "sum(rate(nakama_http_requests_total{status=~'5..'}[5m])) / sum(rate(nakama_http_requests_total[5m])) * 100",
          "format": "percent"
        }
      ]
    }
  ]
}
```

## 监控运维操作

### 启动监控服务
```bash
# 启动完整的监控栈
docker-compose -f docker-compose-monitoring.yml up -d

# 检查服务状态
docker-compose -f docker-compose-monitoring.yml ps

# 预期输出：
# prometheus    Up
# grafana       Up  
# alertmanager  Up
```

### 监控数据查询
```bash
# 使用Prometheus API查询指标
curl -s "http://localhost:9090/api/v1/query?query=up" | jq .

# 查询特定指标
curl -s "http://localhost:9090/api/v1/query?query=rate(nakama_http_requests_total[5m])" | jq .
```

### 告警管理
```bash
# 查看当前告警
curl -s "http://localhost:9090/api/v1/alerts" | jq .

# 静默告警
curl -X POST "http://localhost:9093/api/v2/silences" \
  -H "Content-Type: application/json" \
  -d '{"matchers":[{"name":"alertname","value":"HighErrorRate"}],"startsAt":"2024-01-01T00:00:00Z","endsAt":"2024-01-01T01:00:00Z"}'
```

## 性能优化监控

### 关键性能指标阈值
| 指标 | 警告阈值 | 严重阈值 | 建议操作 |
|------|----------|----------|----------|
| CPU使用率 | 80% | 95% | 水平扩展 |
| 内存使用率 | 85% | 95% | 增加内存 |
| 错误率 | 2% | 5% | 检查代码 |
| 响应时间 | 1秒 | 3秒 | 优化查询 |
| 连接数 | 1000 | 2000 | 调整连接池 |

### 容量规划监控
```promql
# 预测容量需求
predict_linear(nakama_users_online[1w], 3600*24*7)  # 基于一周数据预测

# 资源使用趋势
rate(node_memory_MemTotal_bytes[1w])  # 内存使用趋势
```

## 故障排查指南

### 常见监控问题

#### 指标丢失
```bash
# 检查指标端点
curl http://nakama:7350/metrics | head -20

# 检查Prometheus目标状态
curl -s "http://localhost:9090/api/v1/targets" | jq '.data.activeTargets[] | select(.labels.job=="nakama")'
```

#### 告警不触发
```bash
# 检查规则语法
promtool check rules alerts/*.yml

# 测试告警表达式
curl -s "http://localhost:9090/api/v1/query?query=up" | jq '.data.result'
```

#### 性能数据异常
```bash
# 检查数据抓取间隔
curl -s "http://localhost:9090/api/v1/targets" | jq '.data.activeTargets[] | {job, lastScrape, scrapeDuration}'

# 检查数据点间隔
curl -s "http://localhost:9090/api/v1/query_range?query=up&start=2024-01-01T00:00:00Z&end=2024-01-01T01:00:00Z&step=15s" | jq .
```

## 监控最佳实践

### 配置管理
- 使用版本控制管理监控配置
- 定期备份监控数据
- 设置监控配置的变更审核

### 告警策略
- 设置合理的告警阈值
- 避免告警风暴（设置静默期）
- 分级告警（警告、严重、紧急）

### 性能优化
- 合理设置抓取间隔（平衡实时性和资源消耗）
- 使用记录规则预计算复杂查询
- 定期清理历史数据

监控系统为Nakama-plus提供了全面的可观测性，帮助运维团队及时发现和解决问题。