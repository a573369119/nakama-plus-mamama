# 集群部署指南

## 概述

集群部署适用于**生产环境**，提供高可用性、负载均衡和故障转移能力。支持多节点水平扩展。

## 集群架构

### 组件关系图
```
客户端请求 → Nginx负载均衡器 → Nakama节点集群 (3+节点)
                              ↘ CockroachDB集群 (3+节点)
                              ↘ etcd服务发现 (3+节点)  
                              ↘ Prometheus监控
```

### 端口分配表
| 服务 | 内部端口 | 外部端口 | 协议 | 用途 |
|------|----------|----------|------|------|
| Nginx | 80/443 | 80/443 | HTTP/HTTPS | 负载均衡 |
| Nakama节点 | 7349-7351 | 7349-7351 | gRPC/HTTP | 游戏API |
| CockroachDB | 26257 | 26257 | SQL | 数据库 |
| etcd | 2379-2380 | 2379-2380 | gRPC | 服务发现 |
| Prometheus | 9090 | 9090 | HTTP | 监控 |

## 部署前准备

### 服务器要求
| 资源 | 最小配置 | 推荐配置 | 说明 |
|------|----------|----------|------|
| 服务器数量 | 3台 | 5台+ | 奇数节点避免脑裂 |
| CPU | 4核 | 8核+ | 每节点要求 |
| 内存 | 8GB | 16GB+ | 每节点要求 |
| 存储 | 100GB | 500GB+ | SSD推荐 |
| 网络 | 1Gbps | 10Gbps | 节点间通信 |

### 环境检查脚本
```bash
#!/bin/bash
# 集群环境检查脚本

echo "=== 集群环境检查 ==="

# 检查Docker
docker --version || { echo "Docker未安装"; exit 1; }

# 检查端口占用
for port in 80 443 7349 7350 7351 26257 2379 2380 9090; do
    netstat -tulpn | grep ":$port " && echo "端口 $port 被占用" || echo "端口 $port 可用"
done

# 检查磁盘空间
df -h | grep -v tmpfs

# 检查内存
free -h

echo "=== 检查完成 ==="
```

## 部署步骤

### 1. 准备服务器环境
在所有节点上执行：

```bash
# 1. 安装Docker（如果未安装）
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 2. 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.6.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 3. 创建项目目录
sudo mkdir -p /opt/nakama-plus/{data,config,cert}
sudo chown -R $USER:$USER /opt/nakama-plus
```

### 2. 构建和分发镜像
在主节点上构建镜像，然后分发到所有节点：

```bash
# 在主节点构建镜像
docker build -t nakama-plus:latest .

# 保存镜像为文件
docker save -o nakama-plus.tar nakama-plus:latest

# 分发到其他节点
scp nakama-plus.tar node2:/tmp/
scp nakama-plus.tar node3:/tmp/

# 在其他节点加载镜像
ssh node2 "docker load -i /tmp/nakama-plus.tar"
ssh node3 "docker load -i /tmp/nakama-plus.tar"
```

### 3. 配置集群参数
创建集群配置文件 `cluster-config.yml`：

```yaml
# 集群配置
cluster:
  enabled: true
  # 节点发现配置
  discovery:
    type: "etcd"  # 使用etcd进行服务发现
    etcd:
      endpoints: ["etcd1:2379", "etcd2:2379", "etcd3:2379"]
  
  # 负载均衡配置
  load_balancer:
    type: "nginx"
    strategy: "least_conn"  # 最少连接策略
  
  # 健康检查
  health_check:
    interval: 30s
    timeout: 10s
    retries: 3

# 节点配置（每个节点不同）
node:
  name: "nakama-node-1"  # 每个节点唯一名称
  role: "worker"         # 节点角色：worker或leader
  
# 数据库配置
database:
  addresses: ["cockroachdb1:26257", "cockroachdb2:26257", "cockroachdb3:26257"]
  database: "nakama"
  max_connections: 50
```

### 4. 启动etcd集群
```bash
# 使用docker-compose-cluster.yml启动etcd
docker-compose -f docker-compose-cluster.yml up -d etcd1 etcd2 etcd3

# 检查etcd集群状态
docker exec -it nakama-plus-etcd1-1 etcdctl member list

# 预期输出：
# 8e9e05c52164694d, started, etcd1, http://etcd1:2380, http://etcd1:2379, false
# 8e9e05c52164694e, started, etcd2, http://etcd2:2380, http://etcd2:2379, false  
# 8e9e05c52164694f, started, etcd3, http://etcd3:2380, http://etcd3:2379, false
```

### 5. 启动CockroachDB集群
```bash
# 启动数据库集群
docker-compose -f docker-compose-cluster.yml up -d cockroachdb1 cockroachdb2 cockroachdb3

# 初始化数据库集群
docker exec -it nakama-plus-cockroachdb1-1 cockroach init --insecure

# 检查数据库集群状态
docker exec -it nakama-plus-cockroachdb1-1 cockroach node status --insecure

# 预期输出（显示3个节点都正常）：
# id | address | build | started_at | is_available | is_live
# 1 | cockroachdb1:26257 | v24.1.0 | 2024-01-01 00:00:00 | true | true
# 2 | cockroachdb2:26257 | v24.1.0 | 2024-01-01 00:00:00 | true | true  
# 3 | cockroachdb3:26257 | v24.1.0 | 2024-01-01 00:00:00 | true | true
```

### 6. 启动Nakama节点集群
```bash
# 启动所有Nakama节点
docker-compose -f docker-compose-cluster.yml up -d nakama1 nakama2 nakama3

# 检查节点注册状态
docker exec -it nakama-plus-etcd1-1 etcdctl get --prefix /nakama/nodes

# 预期输出（显示3个节点都注册成功）：
# /nakama/nodes/nakama-node-1 -> {"address":"nakama1:7349","status":"healthy"}
# /nakama/nodes/nakama-node-2 -> {"address":"nakama2:7349","status":"healthy"}
# /nakama/nodes/nakama-node-3 -> {"address":"nakama3:7349","status":"healthy"}
```

### 7. 启动负载均衡和监控
```bash
# 启动Nginx负载均衡
docker-compose -f docker-compose-cluster.yml up -d nginx

# 启动Prometheus监控
docker-compose -f docker-compose-cluster.yml up -d prometheus

# 检查所有服务状态
docker-compose -f docker-compose-cluster.yml ps

# 预期输出：所有服务都显示为Up状态
```

## 配置详解

### docker-compose-cluster.yml 关键配置

#### etcd服务发现配置
```yaml
services:
  etcd1:
    image: quay.io/coreos/etcd:v3.5.0
    command: >
      etcd --name etcd1
      --data-dir /etcd-data
      --listen-client-urls http://0.0.0.0:2379
      --advertise-client-urls http://etcd1:2379
      --listen-peer-urls http://0.0.0.0:2380
      --initial-advertise-peer-urls http://etcd1:2380
      --initial-cluster etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      --initial-cluster-state new
      --initial-cluster-token nakama-cluster
```

#### CockroachDB集群配置
```yaml
cockroachdb1:
  image: cockroachdb/cockroach:latest-v24.1
  command: start --insecure --join=cockroachdb1,cockroachdb2,cockroachdb3
  environment:
    - COCKROACH_HOST=cockroachdb1
```

#### Nakama节点配置（每个节点不同）
```yaml
nakama1:
  image: nakama-plus:latest
  environment:
    - NAKAMA_NODE_NAME=nakama-node-1
    - NAKAMA_CLUSTER_ENABLED=true
    - NAKAMA_ETCD_ENDPOINTS=etcd1:2379,etcd2:2379,etcd3:2379
```

#### Nginx负载均衡配置
```yaml
nginx:
  image: nginx:alpine
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf
  depends_on:
    - nakama1
    - nakama2
    - nakama3
```

### nginx.conf 负载均衡配置
```nginx
upstream nakama_backend {
    # 最少连接负载均衡策略
    least_conn;
    
    # Nakama节点列表
    server nakama1:7350 max_fails=3 fail_timeout=30s;
    server nakama2:7350 max_fails=3 fail_timeout=30s;
    server nakama3:7350 max_fails=3 fail_timeout=30s;
    
    # 健康检查
    check interval=3000 rise=2 fall=3 timeout=1000;
}

server {
    listen 80;
    server_name _;
    
    # API请求代理
    location / {
        proxy_pass http://nakama_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

## 运维操作

### 集群状态监控
```bash
# 查看所有服务状态
docker-compose -f docker-compose-cluster.yml ps

# 检查etcd集群健康
docker exec nakama-plus-etcd1-1 etcdctl endpoint health

# 检查数据库集群状态  
docker exec nakama-plus-cockroachdb1-1 cockroach node status --insecure

# 检查负载均衡状态
curl http://localhost/health

# 查看Prometheus指标
curl http://localhost:9090/api/v1/query?query=up
```

### 节点管理操作
```bash
# 添加新节点
docker-compose -f docker-compose-cluster.yml up -d nakama4

# 优雅停止节点
docker-compose -f docker-compose-cluster.yml stop nakama1

# 移除故障节点
docker-compose -f docker-compose-cluster.yml rm -f nakama1

# 滚动更新（零停机）
docker-compose -f docker-compose-cluster.yml up -d --no-deps --build nakama1
```

### 数据备份和恢复
```bash
# 集群数据库备份
docker exec nakama-plus-cockroachdb1-1 cockroach dump nakama --insecure > cluster-backup.sql

# 集群数据恢复
docker exec -i nakama-plus-cockroachdb1-1 cockroach sql --insecure < cluster-backup.sql

# 定期备份脚本
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

docker exec nakama-plus-cockroachdb1-1 cockroach dump nakama --insecure > $BACKUP_DIR/nakama_backup_$DATE.sql
gzip $BACKUP_DIR/nakama_backup_$DATE.sql

# 保留最近7天备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

### 性能优化配置
```yaml
# 在config.yml中添加性能优化
session:
  cache:
    enabled: true
    size: 10000  # 缓存大小
    
database:
  max_connections: 100  # 增加连接数
  
# JVM调优（如果使用Java客户端）
runtime:
  env:
    - "JAVA_OPTS=-Xmx2g -Xms1g"
```

## 故障排查

### 集群健康检查脚本
```bash
#!/bin/bash
echo "=== 集群健康检查 ==="

# 检查etcd集群
echo "1. 检查etcd集群..."
docker exec nakama-plus-etcd1-1 etcdctl endpoint health || echo "etcd集群异常"

# 检查数据库集群
echo "2. 检查数据库集群..."
docker exec nakama-plus-cockroachdb1-1 cockroach node status --insecure || echo "数据库集群异常"

# 检查Nakama节点
echo "3. 检查Nakama节点..."
for i in 1 2 3; do
    curl -f http://localhost:7350/healthcheck || echo "节点$i异常"
done

# 检查负载均衡
echo "4. 检查负载均衡..."
curl -f http://localhost/health || echo "负载均衡异常"

# 检查监控
echo "5. 检查监控..."
curl -f http://localhost:9090/-/healthy || echo "监控异常"

echo "=== 检查完成 ==="
```

### 常见问题解决

#### 脑裂问题（Split Brain）
```bash
# 当集群出现脑裂时，需要手动干预
docker exec nakama-plus-etcd1-1 etcdctl alarm list

# 如果有报警，清除报警
docker exec nakama-plus-etcd1-1 etcdctl alarm disarm

# 重启etcd集群
docker-compose -f docker-compose-cluster.yml restart etcd1 etcd2 etcd3
```

#### 节点失联
```bash
# 检查节点网络连通性
docker exec nakama-plus-nakama1-1 ping nakama2

# 检查防火墙规则
iptables -L | grep 2379

# 重新加入集群
docker-compose -f docker-compose-cluster.yml restart nakama1
```

#### 性能瓶颈
```bash
# 监控资源使用
docker stats

# 检查慢查询
docker exec nakama-plus-cockroachdb1-1 cockroach sql --insecure -e "SHOW QUERIES;"

# 优化数据库
docker exec nakama-plus-cockroachdb1-1 cockroach sql --insecure -e "SET CLUSTER SETTING sql.stats.automatic_collection.enabled = true;"
```

## 扩展和升级

### 水平扩展
```bash
# 添加更多Nakama节点
docker-compose -f docker-compose-cluster.yml up -d nakama4 nakama5

# 更新负载均衡配置
# 修改nginx.conf，添加新节点到upstream
```

### 版本升级
```bash
# 1. 备份数据
docker exec nakama-plus-cockroachdb1-1 cockroach dump nakama --insecure > upgrade-backup.sql

# 2. 逐个节点升级（滚动更新）
docker-compose -f docker-compose-cluster.yml stop nakama1
docker-compose -f docker-compose-cluster.yml up -d --build nakama1

# 3. 验证新版本
curl http://localhost:7350/version

# 4. 继续升级其他节点
```

集群部署完成！现在你拥有一个高可用的Nakama-plus游戏服务器集群，可以处理大规模并发请求。