# 单节点部署指南

## 概述

单节点部署适用于**开发测试环境**或**小型生产环境**，包含完整的Nakama-plus功能但运行在单个节点上。

## 部署前准备

### 环境检查
```bash
# 检查Docker环境
docker --version
# 输出: Docker version 20.10.17, build 100c701

docker-compose --version  
# 输出: Docker Compose version v2.6.0

# 检查端口占用（重要！）
netstat -an | findstr "7349 7350 7351 8080 9090"
# 如果端口被占用，需要修改配置或停止占用程序
```

### 目录结构准备
```bash
# 创建数据目录（如果不存在）
mkdir -p data/modules data/cert

# 检查项目文件
ls -la docker-compose-single.yml config.sample.yml
```

## 部署步骤

### 1. 构建自定义镜像（可选）
如果你需要最新代码或自定义修改：

```bash
# 构建nakama-plus镜像（使用最新代码）
docker build -t nakama-plus:latest .

# 验证镜像构建成功
docker images | findstr "nakama-plus"
# 输出示例: nakama-plus   latest    a1b2c3d4e5f6   5 minutes ago   1.2GB
```

### 2. 配置环境文件
创建配置文件 `config.yml`：

```yaml
# 复制示例配置并修改
cp config.sample.yml config.yml

# 编辑config.yml，主要修改以下配置：
name: "nakama-single-node"      # 节点名称
runtime:
  http_key: "your-http-key"     # 设置安全的HTTP密钥
  env: []                       # 环境变量
```

### 3. 启动服务
```bash
# 使用单节点配置启动所有服务
docker-compose -f docker-compose-single.yml up -d

# 查看启动状态
docker-compose -f docker-compose-single.yml ps

# 预期输出：
# NAME                          STATUS              PORTS
# nakama-plus-cockroachdb-1     Up 30 seconds (healthy)   0.0.0.0:8080->8080/tcp, 0.0.0.0:26257->26257/tcp
# nakama-plus-nakama-1          Up 25 seconds (healthy)   0.0.0.0:7349-7351->7349-7351/tcp
# nakama-plus-prometheus-1      Up 20 seconds             0.0.0.0:9090->9090/tcp
```

### 4. 验证服务状态
```bash
# 检查所有容器健康状态
docker-compose -f docker-compose-single.yml ps

# 查看Nakama日志
docker-compose -f docker-compose-single.yml logs nakama

# 检查数据库连接
docker exec -it nakama-plus-cockroachdb-1 cockroach sql --insecure -e "SHOW DATABASES;"

# 测试Nakama API
curl http://localhost:7350/v2/console/api/endpoint
```

## 服务访问地址

| 服务 | 访问地址 | 默认端口 | 用途 |
|------|----------|----------|------|
| **Nakama控制台** | http://localhost:7351 | 7351 | 管理界面 |
| **Nakama API** | http://localhost:7350 | 7350 | API接口 |
| **CockroachDB** | http://localhost:8080 | 8080 | 数据库管理 |
| **Prometheus** | http://localhost:9090 | 9090 | 监控面板 |

## 配置详解

### docker-compose-single.yml 解析
```yaml
version: '3.8'
services:
  cockroachdb:
    image: cockroachdb/cockroach:latest-v24.1
    command: start-single-node --insecure  # 单节点模式，无认证
    ports:
      - "8080:8080"    # 管理界面
      - "26257:26257"  # 数据库端口
    volumes:
      - cockroach-data:/cockroach/cockroach-data  # 数据持久化

  nakama:
    image: nakama-plus:latest  # 使用自定义镜像
    depends_on:
      cockroachdb:
        condition: service_healthy  # 等待数据库就绪
    ports:
      - "7349:7349"  # gRPC API
      - "7350:7350"  # HTTP API  
      - "7351:7351"  # 控制台
    volumes:
      - ./data:/nakama/data      # 挂载数据目录
      - ./config.yml:/nakama/config/config.yml  # 配置文件

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"  # 监控面板
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml  # 监控配置

volumes:
  cockroach-data:  # 数据库数据卷
```

### 重要配置参数

#### Nakama配置 (config.yml)
```yaml
name: "nakama-single-node"
data:
  cluster: false  # 单节点模式，关闭集群功能
  # 数据库连接配置
  database:
    address: ["cockroachdb:26257"]
    database: "nakama"
  
# 会话配置
session:
  token_expiry_sec: 86400  # 24小时
  
# 日志配置
logger:
  level: "info"
  format: "json"
```

#### Prometheus配置 (prometheus.yml)
```yaml
global:
  scrape_interval: 15s  # 抓取间隔

scrape_configs:
  - job_name: 'nakama'
    static_configs:
      - targets: ['nakama:7350']  # 监控Nakama指标
```

## 运维操作

### 启动/停止服务
```bash
# 启动服务
docker-compose -f docker-compose-single.yml up -d

# 停止服务
docker-compose -f docker-compose-single.yml down

# 重启服务
docker-compose -f docker-compose-single.yml restart

# 查看服务状态
docker-compose -f docker-compose-single.yml ps
```

### 日志管理
```bash
# 查看所有服务日志
docker-compose -f docker-compose-single.yml logs

# 查看特定服务日志
docker-compose -f docker-compose-single.yml logs nakama

# 实时跟踪日志
docker-compose -f docker-compose-single.yml logs -f nakama

# 查看最近100行日志
docker-compose -f docker-compose-single.yml logs --tail=100 nakama
```

### 数据备份和恢复
```bash
# 备份数据库
docker exec nakama-plus-cockroachdb-1 cockroach dump nakama --insecure > backup.sql

# 恢复数据库
docker exec -i nakama-plus-cockroachdb-1 cockroach sql --insecure < backup.sql

# 备份数据卷
docker run --rm -v nakama-plus_cockroach-data:/volume -v $(pwd):/backup alpine tar czf /backup/cockroach-backup.tar.gz /volume
```

### 性能监控
```bash
# 查看资源使用
docker stats

# 检查容器健康状态
docker inspect nakama-plus-nakama-1 | grep -A 10 "Health"

# 监控API响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:7350/healthcheck
```

## 故障排查

### 常见问题解决

#### 端口冲突
```bash
# 检查端口占用
netstat -an | findstr "7349"

# 如果端口被占用，修改docker-compose文件中的端口映射
# 例如将7349改为8349等
```

#### 数据库连接失败
```bash
# 检查数据库服务状态
docker-compose -f docker-compose-single.yml logs cockroachdb

# 重置数据库（开发环境）
docker-compose -f docker-compose-single.yml down -v
docker-compose -f docker-compose-single.yml up -d
```

#### 镜像构建失败
```bash
# 清理Docker缓存
docker system prune -a

# 重新构建（无缓存）
docker build --no-cache -t nakama-plus:latest .
```

### 健康检查
```bash
# 健康检查脚本
#!/bin/bash
echo "=== Nakama健康检查 ==="

# 检查容器状态
docker-compose -f docker-compose-single.yml ps

# 检查API可用性
curl -f http://localhost:7350/healthcheck || echo "API不可用"

# 检查数据库连接
docker exec nakama-plus-cockroachdb-1 cockroach sql --insecure -e "SELECT 1;" || echo "数据库连接失败"

echo "=== 检查完成 ==="
```

## 扩展配置

### 启用SSL/TLS
```yaml
# 在config.yml中添加
socket:
  ssl:
    enabled: true
    certificate_file: "/nakama/data/cert/server.crt"
    private_key_file: "/nakama/data/cert/server.key"
```

### 自定义插件
```yaml
# 挂载自定义插件
volumes:
  - ./my-plugins:/nakama/data/modules
  - ./config.yml:/nakama/config/config.yml
```

单节点部署已经完成！现在你可以通过上述地址访问各个服务，开始使用Nakama-plus游戏服务器。