# 开发环境搭建指南

## 环境要求

### 必需软件
| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Docker | 20.10+ | 容器运行时环境 |
| Docker Compose | 2.0+ | 容器编排工具 |
| Git | 2.20+ | 版本控制 |

### 可选软件（开发需要）
| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Go | 1.25+ | 编程语言环境 |
| Make | 4.0+ | 构建工具 |
| Node.js | 16+ | 前端开发 |

## 开发环境搭建步骤

### 1. 克隆项目代码
```bash
# 克隆项目到本地
git clone https://github.com/doublemo/nakama-plus.git
cd nakama-plus

# 查看当前分支
git branch -a
```

### 2. 安装Docker环境
```bash
# Windows系统（使用PowerShell）
# 下载并安装Docker Desktop from https://docker.com

# 验证Docker安装
docker --version
docker-compose --version

# 启动Docker服务（如果使用Docker Desktop）
```

### 3. 构建自定义镜像（可选）
如果你需要修改代码并测试，需要重新构建镜像：

```bash
# 构建nakama-plus镜像
docker build -t nakama-plus:latest .

# 验证镜像构建成功
docker images | grep nakama-plus
```

### 4. 启动开发环境
```bash
# 使用单节点配置（推荐开发使用）
docker-compose -f docker-compose-single.yml up -d

# 查看服务状态
docker-compose -f docker-compose-single.yml ps
```

## Go开发环境配置

### 1. 安装Go环境
```bash
# 下载并安装Go from https://golang.org/dl/
# 设置环境变量（Windows）
$env:GOPATH = "$HOME\go"
$env:PATH += ";C:\Go\bin"

# 验证安装
go version
```

### 2. 配置Go模块
```bash
# 进入项目目录
cd nakama-plus

# 下载依赖
go mod download

# 验证依赖
go mod verify
```

### 3. 开发工具配置
```bash
# 使用VSCode进行开发（推荐）
# 安装Go扩展插件

# 或者使用GoLand等专业IDE
```

## 代码构建和测试

### 1. 本地构建测试
```bash
# 构建二进制文件
go build -o nakama-plus .

# 运行测试
go test ./...

# 运行特定测试
go test -v ./server/...
```

### 2. 插件开发构建
```bash
# 构建Go插件（如果需要）
go build --trimpath --mod=vendor --buildmode=plugin -o ./backend.so

# 构建Lua插件支持
# 修改modules目录下的Lua脚本
```

### 3. 集成测试
```bash
# 启动测试环境
docker-compose -f docker-compose-single.yml up -d

# 运行集成测试
go test -tags=integration ./...

# 性能测试
go test -bench=. ./server/...
```

## 开发工作流

### 日常开发流程
```bash
# 1. 拉取最新代码
git pull origin main

# 2. 创建功能分支
git checkout -b feature/your-feature

# 3. 修改代码并测试
go test ./...

# 4. 构建和验证
docker build -t nakama-plus:dev .

# 5. 提交代码
git add .
git commit -m "feat: add your feature"
git push origin feature/your-feature
```

### 调试技巧
```bash
# 使用Delve进行调试
dlv debug ./main.go

# 或者使用日志调试
docker-compose -f docker-compose-single.yml logs nakama

# 实时查看日志
docker-compose -f docker-compose-single.yml logs -f nakama
```

## 常见问题解决

### 端口冲突问题
如果端口被占用，修改docker-compose文件中的端口映射：
```yaml
ports:
  - "8349:7349"  # 改为其他端口
  - "8350:7350"
  - "8351:7351"
```

### 数据库连接问题
```bash
# 重置数据库（开发环境）
docker-compose -f docker-compose-single.yml down -v
docker-compose -f docker-compose-single.yml up -d
```

### 镜像构建失败
```bash
# 清理Docker缓存
docker system prune -a

# 重新构建
docker build --no-cache -t nakama-plus:latest .
```

## 开发最佳实践

### 代码规范
- 遵循Go代码规范（gofmt, golint）
- 编写单元测试覆盖核心逻辑
- 使用有意义的提交信息

### 性能优化
- 避免在热路径上分配内存
- 使用连接池管理数据库连接
- 合理设置缓存策略

### 安全考虑
- 验证所有输入参数
- 使用参数化查询防止SQL注入
- 合理设置权限和访问控制

现在你的开发环境已经准备就绪，可以开始进行nakama-plus的开发和测试了！