# 项目结构详解

## 目录结构总览

```
nakama-plus/
├── 📁 核心代码目录
│   ├── apigrpc/          # gRPC API定义和生成代码
│   ├── console/          # 控制台相关代码
│   ├── flags/            # 命令行参数定义
│   ├── ga/               # Google Analytics集成
│   ├── iap/              # 应用内购买功能
│   ├── internal/         # 内部工具和库
│   ├── migrate/          # 数据库迁移脚本
│   ├── modules/          # 核心模块定义
│   ├── sample_go_module/ # Go模块示例
│   ├── sample_services/  # 微服务示例
│   ├── se/               # 搜索引擎集成
│   ├── server/           # 服务器核心逻辑
│   └── social/           # 社交功能集成
├── 📁 构建和部署
│   ├── build/            # 构建脚本和工具
│   ├── data/             # 数据文件和证书
│   ├── Dockerfile        # 主Docker构建文件
│   ├── docker-compose*.yml # 各种部署配置
│   └── deploy-*.ps1      # PowerShell部署脚本
├── 📁 配置和文档
│   ├── config.sample.yml # 配置文件示例
│   ├── cluster-config.yml # 集群配置
│   ├── nginx.conf        # Nginx负载均衡配置
│   └── docs/             # 项目文档（本目录）
└── 📄 项目文件
    ├── main.go           # 程序入口点
    ├── go.mod            # Go模块定义
    ├── README.md         # 项目说明
    └── CHANGELOG.md      # 变更日志
```

## 核心目录详解

### 1. apigrpc/ - gRPC API层
```
apigrpc/
├── apigrpc.proto         # Protocol Buffers定义文件
├── apigrpc.pb.go         # 生成的Go代码
├── apigrpc_grpc.pb.go    # gRPC服务代码
├── apigrpc.pb.gw.go      # gRPC网关代码
└── apigrpc.swagger.json  # API文档
```

**功能**: 定义和生成gRPC API接口，支持HTTP/JSON和gRPC两种协议。

### 2. server/ - 服务器核心逻辑
```
server/
├── api_*.go              # 各种API处理器
├── console_*.go          # 控制台功能
├── core_*.go             # 核心业务逻辑
├── match_*.go            # 匹配系统
├── peer_*.go             # 节点通信
└── 其他功能模块...
```

**功能**: 包含游戏服务器的所有核心业务逻辑，如用户管理、匹配、存储等。

### 3. internal/ - 内部工具库
```
internal/
├── bytes/                # 字节操作工具
├── cronexpr/             # Cron表达式解析
├── gocache/              # 缓存实现
├── gopher-lua/           # Lua虚拟机
├── satori/               # UUID生成
└── worker/               # 工作池和队列
```

**功能**: 项目内部使用的工具库和第三方库的定制版本。

### 4. build/ - 构建系统
```
build/
├── build.sh              # Linux构建脚本
├── Dockerfile*           # 各种Docker构建配置
├── tools.go              # 构建工具依赖
└── do-marketplace/       # 市场部署相关
```

**功能**: 包含项目构建、打包和部署的相关脚本和配置。

## 重要配置文件

### 1. config.sample.yml
主配置文件示例，包含所有可配置项：
- 数据库连接配置
- 会话管理配置
- 日志级别设置
- 集群配置参数

### 2. cluster-config.yml
集群专用配置：
- 节点发现机制
- 负载均衡设置
- 故障转移配置

### 3. nginx.conf
Nginx负载均衡配置，用于集群部署时的流量分发。

## 构建输出文件

构建过程会生成以下重要文件：
- `nakama-plus` - 主程序二进制文件
- `backend.so` - 插件模块（如果启用）
- Docker镜像 - 包含完整运行环境

## 开发工作流

1. **代码修改** → 修改server/或相关模块
2. **构建测试** → 使用build/中的脚本
3. **本地运行** → 使用docker-compose-single.yml
4. **部署验证** → 使用docker-compose-cluster.yml

这个结构设计确保了代码的组织性、可维护性和可扩展性。