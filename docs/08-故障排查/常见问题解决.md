# 常见问题解决指南

## 问题分类索引

### 部署问题
- [容器启动失败](#容器启动失败)
- [端口冲突](#端口冲突)
- [数据库连接失败](#数据库连接失败)

### 运行问题  
- [服务健康检查失败](#服务健康检查失败)
- [性能问题](#性能问题)
- [内存泄漏](#内存泄漏)

### 配置问题
- [配置文件错误](#配置文件错误)
- [集群配置问题](#集群配置问题)
- [SSL证书问题](#SSL证书问题)

### 网络问题
- [节点间通信失败](#节点间通信失败)
- [负载均衡问题](#负载均衡问题)
- [防火墙配置](#防火墙配置)

## 部署问题解决

### 容器启动失败

**症状**: Docker容器无法启动或立即退出

**检查步骤**:
```bash
# 1. 检查Docker服务状态
docker version
systemctl status docker  # Linux
Get-Service docker      # Windows PowerShell

# 2. 查看详细错误信息
docker-compose -f docker-compose-single.yml up --force-recreate

# 3. 检查镜像是否存在
docker images | grep nakama-plus

# 4. 检查容器日志
docker logs nakama-plus-nakama-1
```

**常见原因和解决方案**:
1. **镜像不存在**: 重新构建镜像 `docker build -t nakama-plus:latest .`
2. **权限问题**: 确保Docker用户有足够权限
3. **资源不足**: 检查磁盘空间和内存 `docker system df`

### 端口冲突

**症状**: 端口已被占用，服务无法启动

**检查步骤**:
```bash
# 检查端口占用情况
netstat -tulpn | grep -E "(7349|7350|7351|8080|9090)"

# Windows PowerShell
Get-NetTCPConnection | Where-Object {$_.LocalPort -in @(7349,7350,7351,8080,9090)}
```

**解决方案**:
```yaml
# 修改docker-compose.yml中的端口映射
services:
  nakama:
    ports:
      - "8349:7349"  # 修改外部端口
      - "8350:7350"
      - "8351:7351"
```

### 数据库连接失败

**症状**: Nakama无法连接到CockroachDB

**检查步骤**:
```bash
# 1. 检查数据库容器状态
docker-compose ps cockroachdb

# 2. 检查数据库日志
docker logs nakama-plus-cockroachdb-1

# 3. 测试数据库连接
docker exec -it nakama-plus-cockroachdb-1 cockroach sql --insecure -e "SHOW DATABASES;"

# 4. 检查网络连通性
docker exec -it nakama-plus-nakama-1 ping cockroachdb
```

**解决方案**:
1. **重启数据库服务**: `docker-compose restart cockroachdb`
2. **重置数据库**: `docker-compose down -v && docker-compose up -d`
3. **检查配置**: 确保config.yml中的数据库地址正确

## 运行问题解决

### 服务健康检查失败

**症状**: 容器状态显示不健康

**检查步骤**:
```bash
# 1. 查看详细健康状态
docker inspect nakama-plus-nakama-1 | jq '.[].State.Health'

# 2. 检查健康检查端点
curl -f http://localhost:7350/healthcheck

# 3. 查看应用日志
docker-compose logs nakama
```

**常见原因**:
1. **依赖服务未就绪**: 确保数据库先启动
2. **配置错误**: 检查config.yml语法
3. **资源不足**: 检查内存和CPU使用

### 性能问题

**症状**: 响应时间慢，高延迟

**检查步骤**:
```bash
# 1. 监控系统资源
docker stats

# 2. 检查数据库性能
docker exec -it nakama-plus-cockroachdb-1 cockroach sql --insecure -e "SHOW QUERIES;"

# 3. 分析慢查询
docker exec -it nakama-plus-cockroachdb-1 cockroach sql --insecure -e "SELECT * FROM [SHOW CLUSTER STATEMENTS] WHERE full_scan = true;"
```

**优化建议**:
1. **增加资源**: 调整Docker内存和CPU限制
2. **优化查询**: 添加数据库索引
3. **缓存策略**: 启用Redis缓存

### 内存泄漏

**症状**: 内存使用持续增长，最终崩溃

**检查步骤**:
```bash
# 1. 监控内存使用趋势
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

# 2. 生成内存分析文件
curl -X POST http://localhost:7350/v2/console/debug/pprof/heap

# 3. 分析Go运行时
curl http://localhost:7350/debug/pprof/goroutine?debug=2
```

**解决方案**:
1. **调整GC参数**: 设置环境变量 `GOGC=100`
2. **代码优化**: 检查插件中的内存分配
3. **重启策略**: 设置自动重启策略

## 配置问题解决

### 配置文件错误

**症状**: 配置解析失败，服务无法启动

**检查步骤**:
```bash
# 1. 验证YAML语法
yamllint config.yml

# 2. 测试配置加载
docker run --rm -v $(pwd)/config.yml:/tmp/config.yml nakama-plus:latest /nakama/nakama-plus --config /tmp/config.yml --dry-run

# 3. 查看配置验证错误
docker-compose logs nakama | grep -i config
```

**常见错误**:
1. **缩进错误**: 使用空格而非制表符
2. **类型错误**: 确保数值类型正确
3. **路径错误**: 使用绝对路径或正确相对路径

### 集群配置问题

**症状**: 集群节点无法发现彼此

**检查步骤**:
```bash
# 1. 检查etcd集群状态
docker exec -it nakama-plus-etcd1-1 etcdctl member list

# 2. 检查节点注册
docker exec -it nakama-plus-etcd1-1 etcdctl get --prefix /nakama/nodes

# 3. 验证网络连通性
docker exec -it nakama-plus-nakama1-1 ping nakama-plus-nakama2-1
```

**解决方案**:
1. **检查防火墙**: 确保节点间端口开放
2. **验证配置**: 确保所有节点使用相同的集群配置
3. **重启发现服务**: 重启etcd集群

### SSL证书问题

**症状**: SSL/TLS配置失败，HTTPS无法访问

**检查步骤**:
```bash
# 1. 验证证书格式
openssl x509 -in server.crt -text -noout

# 2. 检查私钥匹配
openssl x509 -noout -modulus -in server.crt | openssl md5
openssl rsa -noout -modulus -in server.key | openssl md5

# 3. 测试SSL连接
openssl s_client -connect localhost:7350 -servername nakama.example.com
```

**解决方案**:
1. **重新生成证书**: 使用正确的CN和SAN
2. **检查文件权限**: 确保Nakama可以读取证书文件
3. **验证证书链**: 包含完整的证书链

## 网络问题解决

### 节点间通信失败

**症状**: 集群节点无法互相通信

**检查步骤**:
```bash
# 1. 检查网络配置
docker network ls
docker network inspect nakama-plus_default

# 2. 测试节点间连通性
docker exec nakama-plus-nakama1-1 ping nakama-plus-nakama2-1

# 3. 检查DNS解析
docker exec nakama-plus-nakama1-1 nslookup nakama-plus-nakama2-1
```

**解决方案**:
1. **重建网络**: `docker network prune && docker-compose up -d`
2. **检查防火墙**: 确保Docker网络端口开放
3. **验证DNS**: 使用IP地址而非主机名测试

### 负载均衡问题

**症状**: 请求分发不均或某些节点无流量

**检查步骤**:
```bash
# 1. 检查Nginx配置
docker exec -it nakama-plus-nginx-1 nginx -t

# 2. 查看负载均衡状态
docker exec -it nakama-plus-nginx-1 curl http://localhost/nginx_status

# 3. 检查后端节点健康
curl -s http://localhost/health | jq .
```

**解决方案**:
1. **调整负载策略**: 修改nginx.conf中的负载均衡算法
2. **健康检查配置**: 调整健康检查参数
3. **会话保持**: 启用IP哈希策略保持会话

### 防火墙配置

**症状**: 外部无法访问服务

**检查步骤**:
```bash
# 1. 检查防火墙状态
ufw status          # Ubuntu
firewall-cmd --state  # CentOS
Get-NetFirewallProfile  # Windows

# 2. 测试端口连通性
telnet your-server-ip 7350
# 或使用PowerShell
Test-NetConnection -ComputerName your-server-ip -Port 7350

# 3. 检查Docker网络模式
docker inspect nakama-plus-nakama-1 | jq '.[].NetworkSettings.Networks'
```

**解决方案**:
1. **开放端口**: 在防火墙中开放所需端口
2. **检查绑定地址**: 确保服务绑定到0.0.0.0而非127.0.0.1
3. **网络模式**: 使用host网络模式或正确端口映射

## 高级故障排查

### 性能分析工具

#### Go性能分析
```bash
# 生成CPU分析文件
curl http://localhost:7350/debug/pprof/profile -o cpu.pprof

# 生成内存分析文件  
curl http://localhost:7350/debug/pprof/heap -o heap.pprof

# 分析文件
go tool pprof cpu.pprof
go tool pprof heap.pprof
```

#### 数据库性能分析
```bash
# CockroachDB性能分析
docker exec -it nakama-plus-cockroachdb-1 cockroach sql --insecure -e "
SELECT * FROM [SHOW CLUSTER STATEMENTS] 
WHERE execution_count > 100 
ORDER BY mean_rows_desc 
LIMIT 10;"
```

### 日志分析技巧

#### 关键日志模式
```bash
# 错误日志筛选
docker-compose logs nakama | grep -i error

# 慢查询日志
docker-compose logs cockroachdb | grep -i "slow query"

# 连接问题日志
docker-compose logs | grep -E "(timeout|connection refused|connection reset)"
```

#### 日志级别调整
```yaml
# 临时启用调试日志
logger:
  level: "debug"
  format: "console"
```

### 监控告警配置

#### 关键监控指标
```promql
# 服务可用性
up{job="nakama"}

# 错误率
rate(nakama_http_requests_total{status=~"5.."}[5m])

# 响应时间
histogram_quantile(0.95, rate(nakama_http_duration_seconds_bucket[5m]))
```

#### 告警规则示例
```yaml
- alert: HighErrorRate
  expr: rate(nakama_http_requests_total{status=~"5.."}[5m]) > 0.05
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "高错误率检测"
```

## 预防措施

### 定期维护任务
```bash
# 每周维护脚本
#!/bin/bash
echo "=== Nakama-plus定期维护 ==="

# 1. 备份数据
docker exec nakama-plus-cockroachdb-1 cockroach dump nakama --insecure > backup_$(date +%Y%m%d).sql

# 2. 清理日志
docker system prune -f

# 3. 更新镜像
docker-compose pull

# 4. 重启服务（零停机）
docker-compose up -d --no-deps --build

echo "=== 维护完成 ==="
```

### 监控和告警设置
确保配置以下监控项:
- CPU使用率超过80%
- 内存使用率超过85%  
- 错误率超过2%
- 响应时间超过1秒

### 灾难恢复计划
1. **定期备份**: 数据库和配置文件
2. **恢复测试**: 定期测试恢复流程
3. **文档更新**: 保持故障排查指南最新

通过系统性的故障排查方法，可以快速定位和解决Nakama-plus运行中的各种问题。